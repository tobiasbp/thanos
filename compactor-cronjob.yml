apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: compactor-job
  namespace: monitoring
spec:
  # When to run the cronjob
  schedule: "*/60 * * * *"
  # Never run more than one instance
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          volumes:
            # Secret Thanos config with S3 credentials
            - name: thanos-config
              secret:
                secretName: thanos-config
            # Data to work on is put here.
            # Thanos documentation suggests +100GB
            - name: work-dir
              emptyDir:
                sizeLimit: 20Gi
          containers:
          - name: compactor
            image: thanosio/thanos:v0.12.2
            args:
              - "compact"
              # Use config file generated by Thanos
              - "--data-dir=/tmp/compactor"
              # Config for object storage
              - "--objstore.config-file=/etc/thanos/remote_storage.yml"
              # Collect metrics on the Compactor here
              - "--http-address=0.0.0.0:10902"
              # Keep raw samples for 30 days
              - "--retention.resolution-raw=30d"
              # Keep 5m resolution for 365 days
              - "--retention.resolution-5m=365d"
              # Keep 1h resolution forever
              - "--retention.resolution-1h=0d"
              # Disable downsampling
              #- "--downsampling.disable"
              # Logging
              - "--log.level=info"
            ports:
              - name: http-sidecar
                containerPort: 10902
            volumeMounts:
              # Mount Thanos config file here (Object storage)
              - name: thanos-config
                mountPath: /etc/thanos
              # Temporary work in this dir
              - name: work-dir
                mountPath: /tmp/compactor
